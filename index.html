<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å®…å°å­¦æ ¡ å¤©æ°—ãƒ»ç’°å¢ƒæƒ…å ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* Windowsæ¨™æº–ã®UDãƒ•ã‚©ãƒ³ãƒˆï¼ˆBIZ UDPGothicï¼‰ã‚’æœ€å„ªå…ˆã«è¨­å®š */
        body { 
            font-family: 'BIZ UDPGothic', 'BIZ UDGothic', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; 
            background-color: #eef2f5; 
        }
        .weather-icon-shadow { text-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .no-scrollbar { scrollbar-width: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .leaflet-container { border-radius: 1.5rem; }
    </style>
</head>
<body class="h-screen flex flex-col p-4 md:p-6 overflow-hidden">
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (æ¥µå°åŒ–ãƒ»1è¡ŒåŒ–) -->
    <header class="flex-none flex justify-between items-center mb-4 pb-2 border-b-2 border-gray-300">
        <h1 class="text-5xl md:text-6xl font-black text-[#4255a4] tracking-tight">ä¸‰å®…å°å­¦æ ¡ æ°—è±¡æƒ…å ±</h1>
        <p id="current-datetime" class="text-5xl md:text-6xl font-bold text-gray-600 tracking-tighter"></p>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (ä¸Šéƒ¨) -->
    <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6 min-h-0 mb-4 md:mb-6">
        
        <!-- å·¦å´ã‚¨ãƒªã‚¢ -->
        <div class="lg:col-span-7 flex flex-col gap-4 md:gap-6 h-full justify-between">
            
            <!-- ä»Šæ—¥ãƒ»æ˜æ—¥ã®å¤©æ°— -->
            <div style="flex: 3.6;" class="flex gap-4 md:gap-6 min-h-0">
                 <!-- ä»Šæ—¥ -->
                <div class="flex-1 rounded-3xl shadow-xl bg-white p-3 md:p-4 flex flex-col items-center justify-between border-2 border-blue-50 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-3 bg-blue-500"></div>
                    <h2 class="text-3xl md:text-4xl font-black text-gray-500 mt-1">ä»Šæ—¥ã®å¤©æ°—</h2>
                    <div id="today-icon-container" class="text-[100px] md:text-[130px] leading-none my-auto weather-icon-shadow">
                        <!-- JSã§æŒ¿å…¥ -->
                    </div>
                    <div class="text-center w-full mt-auto">
                        <p id="today-detail" class="text-xl md:text-2xl font-black text-gray-800 mb-1"></p>
                        <div id="today-temp" class="tracking-tighter"></div>
                    </div>
                </div>
                <!-- æ˜æ—¥ -->
                <div class="flex-1 rounded-3xl shadow-xl bg-white p-3 md:p-4 flex flex-col items-center justify-between border-2 border-blue-50 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-3 bg-blue-300"></div>
                    <h2 class="text-3xl md:text-4xl font-black text-gray-500 mt-1">æ˜æ—¥ã®å¤©æ°—</h2>
                    <div id="tomorrow-icon-container" class="text-[100px] md:text-[130px] leading-none my-auto weather-icon-shadow">
                        <!-- JSã§æŒ¿å…¥ -->
                    </div>
                    <div class="text-center w-full mt-auto">
                        <p id="tomorrow-detail" class="text-xl md:text-2xl font-black text-gray-800 mb-1"></p>
                        <div id="tomorrow-temp" class="tracking-tighter"></div>
                    </div>
                </div>
            </div>

            <!-- ç’°å¢ƒæƒ…å ± -->
            <div style="flex: 1.5;" class="flex gap-4 md:gap-6 min-h-0">
                <div class="flex-1 bg-white rounded-3xl shadow-lg p-1 md:p-2 text-center border-2 border-gray-100 flex flex-col justify-center items-center relative overflow-hidden">
                    <div class="absolute left-0 top-0 bottom-0 w-2 bg-red-400"></div>
                    <h3 class="text-2xl md:text-3xl font-bold text-gray-500 mb-1">ç¾åœ¨ã®æš‘ã•æŒ‡æ•°(WBGT)</h3>
                    <div id="env-wbgt" class="flex items-center justify-center w-full"><p class="text-gray-400">å–å¾—ä¸­...</p></div>
                </div>
                <div class="flex-1 bg-white rounded-3xl shadow-lg p-1 md:p-2 text-center border-2 border-gray-100 flex flex-col justify-center items-center relative overflow-hidden">
                    <div class="absolute left-0 top-0 bottom-0 w-2 bg-yellow-400"></div>
                    <h3 class="text-2xl md:text-3xl font-bold text-gray-500 mb-1">PM2.5</h3>
                    <div id="env-pm25" class="flex items-center justify-center w-full"><p class="text-gray-400">å–å¾—ä¸­...</p></div>
                </div>
                <div class="flex-1 bg-white rounded-3xl shadow-lg p-1 md:p-2 text-center border-2 border-gray-100 flex flex-col justify-center items-center relative overflow-hidden">
                    <div class="absolute left-0 top-0 bottom-0 w-2 bg-orange-400"></div>
                    <h3 class="text-2xl md:text-3xl font-bold text-gray-500 mb-1">é»„ç ‚ç›®å®‰(PM10)</h3>
                    <div id="env-sand" class="flex items-center justify-center w-full"><p class="text-gray-400">å–å¾—ä¸­...</p></div>
                </div>
            </div>

            <!-- è­¦å ±ãƒ»æ³¨æ„å ±ãƒ‘ãƒãƒ« -->
            <div style="flex: 2.9;" class="min-h-0">
                <div id="warning-panel" class="w-full h-full rounded-3xl shadow-lg bg-white p-4 flex justify-center items-center border-4 border-transparent">
                    <p class="text-xl font-bold text-gray-500">è­¦å ±æƒ…å ±ã‚’å–å¾—ä¸­...</p>
                </div>
            </div>
            
        </div>

        <!-- å³å´ã‚¨ãƒªã‚¢ -->
        <div class="lg:col-span-5 flex flex-col gap-4 md:gap-6 h-full justify-between">
            <!-- é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ -->
            <div id="radar-container" class="flex-[5] rounded-3xl shadow-xl bg-white relative border-[4px] border-white min-h-0">
                <div class="absolute top-4 left-4 z-[400] bg-white/95 backdrop-blur-sm px-3 py-1.5 rounded-2xl shadow-lg font-black text-gray-800 text-base border border-gray-200 flex items-center gap-1">
                    <span>ğŸ“¡</span> é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼
                </div>
                <div id="map" class="w-full h-full rounded-2xl"></div>
            </div>
            
            <!-- å¤©æ°—æ¦‚æ³ -->
            <div class="flex-[3] rounded-3xl shadow-xl bg-white p-4 md:p-6 relative overflow-hidden border-2 border-gray-50 flex flex-col min-h-0">
                <div class="absolute top-0 left-0 w-full h-2 bg-gray-400"></div>
                <h3 class="text-lg md:text-xl font-black text-gray-500 mb-2 flex items-center gap-2 flex-none">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>
                    æ°—è±¡æ¦‚æ³
                </h3>
                <div class="overflow-y-auto flex-grow pr-2 text-2xl md:text-3xl font-bold text-gray-700 leading-relaxed no-scrollbar" id="weather-overview">
                    <p class="text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 1æ™‚é–“ã”ã¨ã®äºˆå ± -->
    <div class="flex-none h-[375px] md:h-[420px] bg-white rounded-3xl shadow-xl p-4 md:p-6 flex flex-col relative overflow-hidden border-2 border-blue-50">
        <div class="absolute top-0 left-0 w-full h-2 bg-blue-500"></div>
        <div class="overflow-x-auto overflow-y-hidden flex-grow relative no-scrollbar" style="scroll-behavior: smooth;">
            <div id="hourly-forecast-container" class="flex gap-4 md:gap-6 min-w-max pb-1 absolute inset-0 items-stretch">
                <p class="text-gray-500 p-4">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const LOCATION_LAT = 34.5717;
        const LOCATION_LON = 135.7764;
        const JMA_OFFICE_CODE = '290000';
        const JMA_AREA_CODE = '290010';
        
        // Open-Meteo URL: æ—¥å°„é‡(shortwave_radiation)ã¨é¢¨é€Ÿ(wind_speed_10m)ã‚’è¿½åŠ 
        const OPEN_METEO_URL = `https://api.open-meteo.com/v1/forecast?latitude=${LOCATION_LAT}&longitude=${LOCATION_LON}&hourly=temperature_2m,relative_humidity_2m,precipitation_probability,weathercode,shortwave_radiation,wind_speed_10m&timezone=Asia%2FTokyo`;

        const WEATHER_ICONS = {
            100: 'â˜€ï¸', 101: 'ğŸŒ¤ï¸', 102: 'ğŸŒ¦ï¸', 103: 'â˜€ï¸', 104: 'ğŸŒ¨ï¸', 110: 'ğŸŒ¤ï¸', 111: 'ğŸŒ¤ï¸', 112: 'ğŸŒ¦ï¸', 113: 'ğŸŒ¦ï¸', 114: 'ğŸŒ¦ï¸',
            200: 'â˜ï¸', 201: 'ğŸŒ¥ï¸', 202: 'ğŸŒ§ï¸', 203: 'ğŸŒ§ï¸', 204: 'ğŸŒ¨ï¸', 205: 'ğŸŒ¨ï¸', 206: 'ğŸŒ§ï¸', 207: 'ğŸŒ§ï¸', 208: 'ğŸŒ§ï¸', 209: 'ğŸŒ§ï¸', 210: 'ğŸŒ¥ï¸', 211: 'ğŸŒ¥ï¸', 212: 'ğŸŒ§ï¸', 213: 'ğŸŒ§ï¸', 214: 'ğŸŒ§ï¸', 215: 'ğŸŒ¨ï¸', 216: 'ğŸŒ¨ï¸', 217: 'ğŸŒ¨ï¸', 218: 'ğŸŒ¨ï¸', 219: 'ğŸŒ¨ï¸',
            300: 'â˜‚ï¸', 301: 'â˜‚ï¸', 302: 'â˜‚ï¸', 303: 'â„ï¸', 304: 'â˜‚ï¸', 306: 'â˜‚ï¸', 308: 'â˜‚ï¸', 309: 'â„ï¸', 311: 'â˜‚ï¸', 313: 'â˜‚ï¸', 314: 'â„ï¸', 315: 'â˜‚ï¸', 316: 'â˜‚ï¸', 317: 'â„ï¸',
            400: 'â˜ƒï¸', 401: 'â˜ƒï¸', 402: 'â˜ƒï¸', 403: 'â˜ƒï¸', 405: 'â˜ƒï¸', 406: 'â˜ƒï¸', 407: 'â˜ƒï¸', 409: 'â˜ƒï¸', 411: 'â˜ƒï¸', 413: 'â˜ƒï¸', 414: 'â˜ƒï¸'
        };

        const WMO_ICONS = {
            0: 'â˜€ï¸', 1: 'ğŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸',
            45: 'ğŸŒ«ï¸', 48: 'ğŸŒ«ï¸',
            51: 'ğŸŒ§ï¸', 53: 'ğŸŒ§ï¸', 55: 'ğŸŒ§ï¸', 56: 'ğŸŒ§ï¸', 57: 'ğŸŒ§ï¸',
            61: 'â˜‚ï¸', 63: 'â˜‚ï¸', 65: 'â˜‚ï¸', 66: 'â˜‚ï¸', 67: 'â˜‚ï¸',
            71: 'â˜ƒï¸', 73: 'â˜ƒï¸', 75: 'â˜ƒï¸', 77: 'â˜ƒï¸',
            80: 'ğŸŒ§ï¸', 81: 'â˜‚ï¸', 82: 'â˜‚ï¸',
            85: 'â˜ƒï¸', 86: 'â˜ƒï¸',
            95: 'ğŸŒ©ï¸', 96: 'â›ˆï¸', 99: 'â›ˆï¸'
        };

        // WBGTè¨ˆç®—é–¢æ•°ï¼ˆç²¾åº¦å‘ä¸Šç‰ˆï¼‰
        // æ°—æ¸©ã€æ¹¿åº¦ã€æ—¥å°„é‡ã€é¢¨é€Ÿã‹ã‚‰å±‹å¤–WBGTã‚’æ¨å®šã™ã‚‹
        function calculateWBGT(temp, humidity, solarRadiation, windSpeed) {
            // 1. æ¹¿çƒæ¸©åº¦(Tw)ã®æ¨å®š (Stull, 2011 ã®å¼ã‚’ä½¿ç”¨)
            // è¤‡é›‘ãªå¼ã§ã™ãŒã€æ°—æ¸©ã¨æ¹¿åº¦ã‹ã‚‰ã‹ãªã‚Šæ­£ç¢ºãªæ¹¿çƒæ¸©åº¦ãŒå‡ºã¾ã™
            const tw = temp * Math.atan(0.151977 * Math.pow(humidity + 8.313659, 0.5)) 
                     + Math.atan(temp + humidity) 
                     - Math.atan(humidity - 1.676331) 
                     + 0.00391838 * Math.pow(humidity, 1.5) * Math.atan(0.023101 * humidity) 
                     - 4.686035;

            // 2. é»’çƒæ¸©åº¦(Tg)ã®æ¨å®š (å±‹å¤–æ—¥å‘ãƒ¢ãƒ‡ãƒ«)
            // é»’çƒæ¸©åº¦ã¯æ—¥å°„é‡(W/m2)ã§ä¸Šæ˜‡ã—ã€é¢¨é€Ÿ(m/s)ã§ä½ä¸‹ã™ã‚‹
            // ç°¡æ˜“æ¨è¨ˆãƒ¢ãƒ‡ãƒ«: Tg â‰’ Ta + (0.018 * æ—¥å°„é‡) - (0.8 * é¢¨é€Ÿ)
            // â€»ä¿‚æ•°ã¯ä¸€èˆ¬çš„ãªçµŒé¨“å‰‡ã«åŸºã¥ãã€å®‰å…¨å´ï¼ˆé«˜ã‚ï¼‰ã«å‡ºã‚‹ã‚ˆã†èª¿æ•´
            let tgDiff = (0.018 * solarRadiation) - (0.8 * windSpeed);
            if (tgDiff < 0) tgDiff = 0; // æ°—æ¸©ã‚ˆã‚Šä½ãã¯ãªã‚‰ãªã„ã¨ã™ã‚‹
            const tg = temp + tgDiff;

            // 3. å±‹å¤–WBGT = 0.7 * æ¹¿çƒæ¸©åº¦ + 0.2 * é»’çƒæ¸©åº¦ + 0.1 * ä¹¾çƒæ¸©åº¦(æ°—æ¸©)
            const wbgt = 0.7 * tw + 0.2 * tg + 0.1 * temp;

            return Math.round(wbgt);
        }

        // WBGTã®ãƒ¬ãƒ™ãƒ«åˆ¤å®š
        function getWBGTLevel(wbgt) {
            if (wbgt >= 31) return { text: "å±é™º", color: "text-purple-600", bg: "bg-purple-200", border: "border-purple-300", text_w: "text-purple-800" };
            if (wbgt >= 28) return { text: "å³é‡è­¦æˆ’", color: "text-red-500", bg: "bg-red-200", border: "border-red-300", text_w: "text-red-800" };
            if (wbgt >= 25) return { text: "è­¦æˆ’", color: "text-orange-500", bg: "bg-orange-200", border: "border-orange-300", text_w: "text-orange-800" };
            if (wbgt >= 21) return { text: "æ³¨æ„", color: "text-yellow-500", bg: "bg-yellow-200", border: "border-yellow-300", text_w: "text-yellow-800" };
            return { text: "ã»ã¼å®‰å…¨", color: "text-blue-500", bg: "bg-blue-100", border: "border-blue-200", text_w: "text-blue-800" };
        }

        // æ™‚è¨ˆ
        function updateClock() {
            const now = new Date();
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const m = now.getMonth() + 1;
            const d = now.getDate();
            const day = days[now.getDay()];
            const h = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            
            document.getElementById('current-datetime').textContent = `${m}æœˆ${d}æ—¥(${day}) ${h}:${min}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼
        let map;
        function initRadar() {
            if (map) return;
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([LOCATION_LAT, LOCATION_LON], 11);
            L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', { maxZoom: 15, opacity: 0.8 }).addTo(map);

            fetch('https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json')
                .then(res => res.json())
                .then(data => {
                    if (!data || data.length === 0) return;
                    const latest = data[0].basetime;
                    const valid = data[0].validtime;
                    L.tileLayer(`https://www.jma.go.jp/bosai/jmatile/data/nowc/${latest}/none/${valid}/surf/hrpns/{z}/{x}/{y}.png`, { opacity: 0.6, maxZoom: 15 }).addTo(map);
                }).catch(e => console.error("ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—", e));
                
            const markerHtml = `<div class="w-5 h-5 bg-red-500 rounded-full border-4 border-white shadow-lg animate-bounce"></div>`;
            const icon = L.divIcon({ className: '', html: markerHtml, iconSize: [20, 20] });
            L.marker([LOCATION_LAT, LOCATION_LON], { icon: icon }).addTo(map);
        }

        // å¤©æ°—æ¦‚æ³
        async function fetchWeatherOverview() {
            try {
                const res = await fetch(`https://www.jma.go.jp/bosai/forecast/data/overview_forecast/${JMA_OFFICE_CODE}.json`);
                const data = await res.json();
                document.getElementById('weather-overview').innerHTML = data.text.replace(/\n/g, '<br>');
            } catch (error) {
                document.getElementById('weather-overview').innerHTML = '<span class="text-gray-400">ç¾åœ¨ã€æ°—è±¡æ¦‚æ³ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚</span>';
            }
        }

        // å¤©æ°—äºˆå ±
        async function fetchDailyForecast() {
            try {
                const res = await fetch(`https://www.jma.go.jp/bosai/forecast/data/forecast/${JMA_OFFICE_CODE}.json`);
                const data = await res.json();
                
                const areaData = data[0].timeSeries[0].areas.find(a => a.area.code === JMA_AREA_CODE);
                const todayCode = areaData.weatherCodes[0];
                const tomorrowCode = areaData.weatherCodes[1];
                const todayText = areaData.weathers[0];
                const tomorrowText = areaData.weathers[1];

                let todayMax = '--', todayMin = '--', tomorrowMax = '--', tomorrowMin = '--';
                
                try {
                    const omRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LOCATION_LAT}&longitude=${LOCATION_LON}&daily=temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`);
                    const omData = await omRes.json();
                    if (omData && omData.daily) {
                        const now = new Date();
                        const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                        now.setDate(now.getDate() + 1);
                        const tomorrowStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

                        const todayIndex = omData.daily.time.indexOf(todayStr);
                        const tomorrowIndex = omData.daily.time.indexOf(tomorrowStr);

                        if (todayIndex !== -1) { 
                            todayMax = Math.round(omData.daily.temperature_2m_max[todayIndex]); 
                            todayMin = Math.round(omData.daily.temperature_2m_min[todayIndex]); 
                        }
                        if (tomorrowIndex !== -1) { 
                            tomorrowMax = Math.round(omData.daily.temperature_2m_max[tomorrowIndex]); 
                            tomorrowMin = Math.round(omData.daily.temperature_2m_min[tomorrowIndex]); 
                        }
                    }
                } catch (e) { console.error("Open-Meteoå–å¾—å¤±æ•—", e); }

                document.getElementById('today-icon-container').textContent = WEATHER_ICONS[todayCode] || 'â“';
                document.getElementById('today-detail').textContent = todayText.replace(/ã€€/g, '');
                document.getElementById('today-temp').innerHTML = `
                    <span class="text-3xl md:text-4xl font-black text-red-500">${todayMax}<span class="text-xl">â„ƒ</span></span>
                    <span class="text-2xl text-gray-300 mx-1 font-light">/</span>
                    <span class="text-3xl md:text-4xl font-black text-blue-500">${todayMin}<span class="text-xl">â„ƒ</span></span>
                `;

                document.getElementById('tomorrow-icon-container').textContent = WEATHER_ICONS[tomorrowCode] || 'â“';
                document.getElementById('tomorrow-detail').textContent = tomorrowText.replace(/ã€€/g, '');
                document.getElementById('tomorrow-temp').innerHTML = `
                    <span class="text-3xl md:text-4xl font-black text-red-500">${tomorrowMax}<span class="text-xl">â„ƒ</span></span>
                    <span class="text-2xl text-gray-300 mx-1 font-light">/</span>
                    <span class="text-3xl md:text-4xl font-black text-blue-500">${tomorrowMin}<span class="text-xl">â„ƒ</span></span>
                `;

            } catch (error) { console.error("äºˆå ±å–å¾—ã‚¨ãƒ©ãƒ¼", error); }
        }

        // ç’°å¢ƒæƒ…å ±ï¼ˆæ—¥å°„é‡ãƒ»é¢¨é€Ÿã‚’è€ƒæ…®ã—ãŸWBGTè¨ˆç®—ï¼‰
        async function fetchEnvironmentalData() {
            try {
                // Currentã‚‚å«ã‚€APIã‚’ã‚³ãƒ¼ãƒ« (shortwave_radiation, wind_speed_10m è¿½åŠ )
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LOCATION_LAT}&longitude=${LOCATION_LON}&current=temperature_2m,relative_humidity_2m,shortwave_radiation,wind_speed_10m&timezone=Asia%2FTokyo`);
                const weatherData = await weatherRes.json();
                
                const temp = weatherData.current.temperature_2m;
                const humidity = weatherData.current.relative_humidity_2m;
                const solar = weatherData.current.shortwave_radiation || 0;
                const wind = weatherData.current.wind_speed_10m || 0;

                // æ–°ã—ã„è¨ˆç®—é–¢æ•°ã‚’ä½¿ç”¨
                const wbgtVal = calculateWBGT(temp, humidity, solar, wind);
                const level = getWBGTLevel(wbgtVal);

                const aqRes = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LOCATION_LAT}&longitude=${LOCATION_LON}&current=pm10,pm2_5&timezone=Asia%2FTokyo`);
                const aqData = await aqRes.json();
                const pm25Val = Math.round(aqData.current.pm2_5);
                const pm10Val = Math.round(aqData.current.pm10);

                let pm25Level = "å°‘ãªã„"; let pm25Color = "text-green-500";
                if(pm25Val > 35) { pm25Level = "å¤šã„"; pm25Color = "text-red-500"; }
                else if(pm25Val > 15) { pm25Level = "æ™®é€š"; pm25Color = "text-yellow-500"; }

                let sandLevel = "é£›æ¥ãªã—"; let sandColor = "text-green-500";
                if(pm10Val > 50) { sandLevel = "å¤šã„"; sandColor = "text-yellow-600"; }
                else if(pm10Val > 30) { sandLevel = "ã‚„ã‚„é£›æ¥"; sandColor = "text-yellow-500"; }

                document.getElementById('env-wbgt').innerHTML = `
                    <div class="flex flex-col items-center justify-center w-full">
                        <span class="text-base md:text-lg font-bold text-gray-500 mb-0.5">WBGT:${wbgtVal} / æ¹¿åº¦:${humidity}%</span>
                        <span class="text-3xl md:text-4xl lg:text-5xl font-black tracking-tight ${level.color} drop-shadow-sm">${level.text}</span>
                    </div>`;
                    
                document.getElementById('env-pm25').innerHTML = `
                    <div class="flex flex-col items-center justify-center w-full">
                        <span class="text-base md:text-lg font-bold text-gray-500 mb-0.5">${pm25Val} Î¼g/mÂ³</span>
                        <span class="text-3xl md:text-4xl lg:text-5xl font-black tracking-tight ${pm25Color} drop-shadow-sm">${pm25Level}</span>
                    </div>`;
                    
                document.getElementById('env-sand').innerHTML = `
                    <div class="flex flex-col items-center justify-center w-full">
                        <span class="text-base md:text-lg font-bold text-gray-500 mb-0.5">PM10: ${pm10Val}Î¼g</span>
                        <span class="text-3xl md:text-4xl lg:text-5xl font-black tracking-tight ${sandColor} drop-shadow-sm">${sandLevel}</span>
                    </div>`;

            } catch (error) { console.error("ç’°å¢ƒãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—", error); }
        }

        // è­¦å ±
        async function fetchWarnings() {
            const panel = document.getElementById('warning-panel');
            const noWarningHtml = `
                <div class="flex flex-col items-center justify-center gap-2 text-center w-full">
                    <span class="text-6xl md:text-7xl drop-shadow-md">ğŸŸ¢</span>
                    <h2 class="text-3xl md:text-4xl lg:text-5xl font-black text-green-700 mt-2">ç¾åœ¨ã€è­¦å ±ãƒ»æ³¨æ„å ±ã¯ã‚ã‚Šã¾ã›ã‚“</h2>
                </div>
            `;
            const noWarningClass = "w-full h-full rounded-3xl shadow-lg bg-green-50 p-4 flex justify-center items-center border-4 border-green-400";

            try {
                const res = await fetch(`https://www.jma.go.jp/bosai/warning/data/warning/${JMA_OFFICE_CODE}.json`);
                const data = await res.json();
                let areas = data.timeSeries ? data.timeSeries[0].areas : (data[0].timeSeries ? data[0].timeSeries[0].areas : []);
                const miyakeData = areas.find(a => a.area.code === "2936200");

                if (!miyakeData || !miyakeData.warnings || miyakeData.warnings.length === 0) {
                    panel.className = noWarningClass; panel.innerHTML = noWarningHtml; return;
                }

                const warningsData = await fetch('https://www.jma.go.jp/bosai/warning/const/warning.json').then(r => r.json());
                let specialWarnings = [], warnings = [], advisories = [];

                miyakeData.warnings.forEach(w => {
                    if (w.status === "ç™ºè¡¨" || w.status === "ç¶™ç¶š") {
                        const wInfo = warningsData[w.code];
                        if (wInfo) {
                            if (wInfo.name.includes('ç‰¹åˆ¥è­¦å ±')) specialWarnings.push(wInfo.name);
                            else if (wInfo.name.includes('è­¦å ±')) warnings.push(wInfo.name);
                            else if (wInfo.name.includes('æ³¨æ„å ±')) advisories.push(wInfo.name);
                        }
                    }
                });

                if (specialWarnings.length === 0 && warnings.length === 0 && advisories.length === 0) {
                    panel.className = noWarningClass; panel.innerHTML = noWarningHtml; return;
                }

                let html = '<div class="flex flex-col gap-2 justify-center items-center w-full h-full text-center">';
                let panelClass = "w-full h-full rounded-3xl shadow-xl p-4 flex justify-center items-center border-[4px] ";

                if (specialWarnings.length > 0) {
                    panelClass += "bg-purple-100 border-purple-600";
                    html += `<span class="text-[70px] md:text-[90px] animate-bounce drop-shadow-md">ğŸš¨</span><span class="text-5xl md:text-6xl lg:text-7xl font-black text-purple-800 leading-tight">${specialWarnings.join('<br>')}</span>`;
                } else if (warnings.length > 0) {
                    panelClass += "bg-red-100 border-red-500";
                    html += `<span class="text-[70px] md:text-[90px] animate-pulse drop-shadow-md">ğŸ”´</span><span class="text-5xl md:text-6xl lg:text-7xl font-black text-red-700 leading-tight">${warnings.join('<br>')}</span>`;
                } else {
                    panelClass += "bg-yellow-50 border-yellow-400";
                    html += `<span class="text-[60px] md:text-[80px] drop-shadow-md">ğŸŸ¡</span><span class="text-4xl md:text-5xl lg:text-6xl font-black text-yellow-700 leading-tight">${advisories.join(' / ')}</span>`;
                }
                html += '</div>';
                panel.className = panelClass; panel.innerHTML = html;

            } catch (error) { panel.className = noWarningClass; panel.innerHTML = noWarningHtml; }
        }

        // 1æ™‚é–“ã”ã¨ã®äºˆå ±ï¼ˆç²¾åº¦å‘ä¸Šç‰ˆWBGTé©ç”¨ï¼‰
        async function fetchHourlyForecast() {
            try {
                // const res = await fetch(OPEN_METEO_URL); // ä¸Šã§å®šç¾©ã—ãŸURLã‚’ä½¿ç”¨
                const res = await fetch(OPEN_METEO_URL);
                const data = await res.json();
                const container = document.getElementById('hourly-forecast-container');
                let html = '';

                const now = new Date();
                const currentHourTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), 0, 0).getTime();
                let displayedCount = 0;

                for (let i = 0; i < data.hourly.time.length && displayedCount < 24; i++) {
                    const dataTime = new Date(data.hourly.time[i]);
                    if (dataTime.getTime() < currentHourTime) continue;

                    const timeStr = dataTime.getHours() + 'æ™‚';
                    const temp = Math.round(data.hourly.temperature_2m[i]);
                    const pop = data.hourly.precipitation_probability[i] ?? 0;
                    const humidity = data.hourly.relative_humidity_2m[i] ?? 0;
                    const solar = data.hourly.shortwave_radiation[i] || 0;
                    const wind = data.hourly.wind_speed_10m[i] || 0;
                    const code = data.hourly.weathercode[i];
                    const icon = WMO_ICONS[code] || 'â“';

                    // æ–°ã—ã„è¨ˆç®—é–¢æ•°ã‚’ä½¿ç”¨
                    const wbgt = calculateWBGT(temp, humidity, solar, wind);
                    const level = getWBGTLevel(wbgt);

                    html += `
                        <div class="flex flex-col items-center justify-between min-w-[150px] md:min-w-[170px] bg-gray-50/80 hover:bg-white rounded-2xl p-4 md:p-5 border-2 border-gray-100 shadow-sm h-full gap-2">
                            <span class="text-2xl md:text-3xl font-black text-gray-500">${timeStr}</span>
                            <span class="text-7xl md:text-[80px] my-auto drop-shadow-sm">${icon}</span>
                            <span class="text-4xl md:text-5xl font-black text-gray-800">${temp}â„ƒ</span>
                            
                            <div class="flex items-center justify-center gap-1 w-full text-blue-700 bg-blue-100/50 px-2 py-1 rounded-lg mt-1">
                                <span class="text-base md:text-lg">ğŸ’§é™æ°´</span>
                                <span class="text-lg md:text-xl font-black">${pop}%</span>
                            </div>
                            
                            <div class="w-full flex flex-col items-center justify-center ${level.bg} ${level.text_w} ${level.border} border py-1.5 rounded-lg mt-auto">
                                <span class="text-xs font-bold opacity-80 mb-0.5">WBGT:${wbgt} / æ¹¿åº¦:${humidity}%</span>
                                <span class="text-base md:text-lg font-black">${level.text}</span>
                            </div>
                        </div>
                    `;
                    displayedCount++;
                }
                container.innerHTML = html;

            } catch (error) {
                console.error(error);
                document.getElementById('hourly-forecast-container').innerHTML = '<p class="text-red-500 p-4 font-bold">äºˆå ±å–å¾—å¤±æ•—</p>';
            }
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.onload = () => {
            initRadar();
            fetchWeatherOverview();
            fetchDailyForecast();
            fetchEnvironmentalData();
            fetchWarnings();
            fetchHourlyForecast();

            // 10åˆ†ãŠãã«æ›´æ–°
            setInterval(() => {
                fetchWeatherOverview();
                fetchDailyForecast();
                fetchEnvironmentalData();
                fetchWarnings();
                fetchHourlyForecast();
            }, 10 * 60 * 1000);
        };
    </script>
</body>
</html>