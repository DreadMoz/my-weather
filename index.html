<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å®…å°å­¦æ ¡ å¤©æ°—ãƒ»ç’°å¢ƒæƒ…å ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { 
            font-family: 'BIZ UDPGothic', 'BIZ UDGothic', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; 
            background-color: #eef2f5; 
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
        }
        .weather-icon-shadow { text-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .leaflet-container { border-radius: 1rem; }
    </style>
</head>
<body class="flex flex-col p-2 h-screen">
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="flex-none flex justify-between items-center mb-2 pb-1 border-b-2 border-gray-300">
        <h1 class="text-4xl font-black text-[#4255a4] tracking-tight">ä¸‰å®…å°å­¦æ ¡ æ°—è±¡æƒ…å ±</h1>
        <p id="current-datetime" class="text-4xl font-bold text-gray-600 tracking-tighter"></p>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="flex-grow grid grid-cols-12 gap-3 min-h-0 mb-3">
        
        <!-- å·¦å´ãƒ¡ã‚¤ãƒ³ (å¤©æ°— + æŒ‡æ•° + è­¦å ±) -->
        <div class="col-span-8 flex flex-col gap-3 h-full">
            
            <div class="flex gap-3 h-[70%]">
                <!-- ä»Šæ—¥ã®å¤©æ°— -->
                <div class="flex-[2] rounded-2xl shadow-lg bg-white p-3 flex flex-col items-center justify-between border-2 border-blue-50 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-blue-500"></div>
                    <h2 class="text-2xl font-black text-gray-400">ä»Šæ—¥ã®å¤©æ°—</h2>
                    <div id="today-icon-container" class="text-9xl leading-none weather-icon-shadow my-1"></div>
                    <div class="text-center w-full">
                        <p id="today-detail" class="text-2xl font-bold text-gray-700 truncate px-1"></p>
                        <div id="today-temp" class="tracking-tighter"></div>
                    </div>
                </div>

                <!-- æ˜æ—¥ã®å¤©æ°— -->
                <div class="flex-[2] rounded-2xl shadow-lg bg-white p-3 flex flex-col items-center justify-between border-2 border-blue-50 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-blue-300"></div>
                    <h2 class="text-2xl font-black text-gray-400">æ˜æ—¥ã®å¤©æ°—</h2>
                    <div id="tomorrow-icon-container" class="text-9xl leading-none weather-icon-shadow my-1"></div>
                    <div class="text-center w-full">
                        <p id="tomorrow-detail" class="text-2xl font-bold text-gray-700 truncate px-1"></p>
                        <div id="tomorrow-temp" class="tracking-tighter"></div>
                    </div>
                </div>

                <!-- æŒ‡æ•°æƒ…å ± (ç¸¦ä¸¦ã³) -->
                <div class="flex-1 flex flex-col gap-3">
                    <div class="flex-1 bg-white rounded-2xl shadow p-2 text-center border-l-4 border-red-400 flex flex-col justify-center">
                        <h3 class="text-sm font-bold text-gray-400 leading-none mb-1">æš‘ã•æŒ‡æ•°</h3>
                        <div id="env-wbgt" class="text-5xl font-black leading-tight">...</div>
                    </div>
                    <div class="flex-1 bg-white rounded-2xl shadow p-2 text-center border-l-4 border-yellow-400 flex flex-col justify-center">
                        <h3 class="text-sm font-bold text-gray-400 leading-none mb-1">PM2.5</h3>
                        <div id="env-pm25" class="text-4xl font-black leading-tight">...</div>
                    </div>
                    <div class="flex-1 bg-white rounded-2xl shadow p-2 text-center border-l-4 border-orange-400 flex flex-col justify-center">
                        <h3 class="text-sm font-bold text-gray-400 leading-none mb-1">é»„ç ‚</h3>
                        <div id="env-sand" class="text-4xl font-black leading-tight">...</div>
                    </div>
                </div>
            </div>

            <!-- è­¦å ± (ä¸‹ã®æ®‹ã‚Šã‚¹ãƒšãƒ¼ã‚¹) -->
            <div class="flex-grow min-h-0">
                <div id="warning-panel" class="w-full h-full rounded-2xl shadow-md bg-white p-2 flex justify-center items-center">
                    <p class="text-lg font-bold text-gray-400">å–å¾—ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- å³å´ (ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒ»æ¦‚æ³) -->
        <div class="col-span-4 flex flex-col gap-3 h-full">
            <div id="radar-container" class="flex-[3] rounded-2xl shadow-lg bg-white relative border-2 border-white min-h-0">
                <div class="absolute top-2 left-2 z-[400] bg-white/90 backdrop-blur-sm px-2 py-0.5 rounded-lg shadow text-xs font-bold text-gray-800 border">
                    ğŸ“¡ é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼
                </div>
                <div id="map" class="w-full h-full rounded-2xl"></div>
            </div>
            
            <div class="flex-[2] rounded-2xl shadow-lg bg-white p-3 relative overflow-hidden flex flex-col min-h-0 border-t-4 border-gray-400">
                <h3 class="text-sm font-bold text-gray-400 mb-1">æ°—è±¡æ¦‚æ³</h3>
                <div class="overflow-y-auto flex-grow text-lg font-bold text-gray-600 leading-snug no-scrollbar" id="weather-overview">
                    <p class="text-gray-300 text-sm">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 1æ™‚é–“ã”ã¨ã®äºˆå ± -->
    <div class="flex-none h-[250px] bg-white rounded-2xl shadow-lg p-3 relative overflow-hidden border-t-4 border-blue-500">
        <div class="overflow-x-auto overflow-y-hidden h-full no-scrollbar">
            <div id="hourly-forecast-container" class="flex gap-3 h-full">
                <p class="text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const LOCATION_LAT = 34.5717;
        const LOCATION_LON = 135.7764;
        const JMA_OFFICE_CODE = '290000';
        const JMA_AREA_CODE = '290010';
        const MIYAKE_AREA_CODE = '2936200';
        const OPEN_METEO_URL = `https://api.open-meteo.com/v1/forecast?latitude=${LOCATION_LAT}&longitude=${LOCATION_LON}&hourly=temperature_2m,relative_humidity_2m,shortwave_radiation,wind_speed_10m,weathercode&timezone=Asia%2FTokyo`;

        const WEATHER_ICONS = { 100: 'â˜€ï¸', 101: 'ğŸŒ¤ï¸', 102: 'ğŸŒ¦ï¸', 103: 'â˜€ï¸', 104: 'ğŸŒ¨ï¸', 110: 'ğŸŒ¤ï¸', 200: 'â˜ï¸', 202: 'ğŸŒ§ï¸', 300: 'â˜‚ï¸', 400: 'â˜ƒï¸' };
        const WMO_ICONS = { 0: 'â˜€ï¸', 1: 'ğŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸', 45: 'ğŸŒ«ï¸', 51: 'ğŸŒ§ï¸', 61: 'â˜‚ï¸', 71: 'â˜ƒï¸', 80: 'ğŸŒ§ï¸', 95: 'ğŸŒ©ï¸' };

        function calculateWBGT(t, h, s, w) {
            const tw = t * Math.atan(0.151977 * Math.pow(h + 8.313659, 0.5)) + Math.atan(t + h) - Math.atan(h - 1.676331) + 0.00391838 * Math.pow(h, 1.5) * Math.atan(0.023101 * h) - 4.686035;
            let tg = t + (Math.max(0, (0.018 * s) - (0.8 * w)));
            return Math.round(0.7 * tw + 0.2 * tg + 0.1 * t);
        }

        function getWBGTLevel(val) {
            if (val >= 31) return { text: "å±é™º", color: "text-purple-600", bg: "bg-purple-100", border: "border-purple-400" };
            if (val >= 28) return { text: "å³é‡è­¦æˆ’", color: "text-red-600", bg: "bg-red-100", border: "border-red-400" };
            if (val >= 25) return { text: "è­¦æˆ’", color: "text-orange-600", bg: "bg-orange-100", border: "border-orange-400" };
            if (val >= 21) return { text: "æ³¨æ„", color: "text-yellow-600", bg: "bg-yellow-100", border: "border-yellow-400" };
            return { text: "ã»ã¼å®‰å…¨", color: "text-blue-600", bg: "bg-blue-50", border: "border-blue-300" };
        }

        function updateClock() {
            const n = new Date();
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            document.getElementById('current-datetime').textContent = `${n.getMonth()+1}/${n.getDate()}(${days[n.getDay()]}) ${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
        }

        let map;
        function initRadar() {
            if (map) return;
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([LOCATION_LAT, LOCATION_LON], 11);
            L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', { opacity: 0.8 }).addTo(map);
            fetch('https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json').then(r => r.json()).then(d => {
                if(!d || d.length === 0) return;
                const l = d[0].basetime, v = d[0].validtime;
                L.tileLayer(`https://www.jma.go.jp/bosai/jmatile/data/nowc/${l}/none/${v}/surf/hrpns/{z}/{x}/{y}.png`, { opacity: 0.6 }).addTo(map);
            });
            L.marker([LOCATION_LAT, LOCATION_LON], { icon: L.divIcon({ className: '', html: '<div class="w-3 h-3 bg-red-500 rounded-full border-2 border-white shadow-md animate-ping"></div>' }) }).addTo(map);
        }

        async function updateData() {
            try {
                // å¤©æ°—äºˆå ±
                const fRes = await fetch(`https://www.jma.go.jp/bosai/forecast/data/forecast/${JMA_OFFICE_CODE}.json`);
                const fData = await fRes.json();
                const miyakeF = fData[0].timeSeries[0].areas.find(a => a.area.code === JMA_AREA_CODE);
                
                document.getElementById('today-icon-container').textContent = WEATHER_ICONS[miyakeF.weatherCodes[0]] || 'â˜ï¸';
                document.getElementById('today-detail').textContent = miyakeF.weathers[0].replace(/ã€€/g, '');
                document.getElementById('tomorrow-icon-container').textContent = WEATHER_ICONS[miyakeF.weatherCodes[1]] || 'â˜ï¸';
                document.getElementById('tomorrow-detail').textContent = miyakeF.weathers[1].replace(/ã€€/g, '');

                const omRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LOCATION_LAT}&longitude=${LOCATION_LON}&current=temperature_2m,relative_humidity_2m,shortwave_radiation,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`);
                const om = await omRes.json();
                
                // æ°—æ¸©ã«ã¯ã€Œâ„ƒã€ã‚’å¾©æ´»
                document.getElementById('today-temp').innerHTML = `<span class="text-4xl font-black text-red-500">${Math.round(om.daily.temperature_2m_max[0])}<span class="text-xl">â„ƒ</span></span><span class="text-gray-300 mx-1">/</span><span class="text-4xl font-black text-blue-500">${Math.round(om.daily.temperature_2m_min[0])}<span class="text-xl">â„ƒ</span></span>`;
                document.getElementById('tomorrow-temp').innerHTML = `<span class="text-4xl font-black text-red-500">${Math.round(om.daily.temperature_2m_max[1])}<span class="text-xl">â„ƒ</span></span><span class="text-gray-300 mx-1">/</span><span class="text-4xl font-black text-blue-500">${Math.round(om.daily.temperature_2m_min[1])}<span class="text-xl">â„ƒ</span></span>`;

                // ç’°å¢ƒæŒ‡æ•° (æš‘ã•æŒ‡æ•°ã¯æ•°å€¤ã®ã¿ã®ã¾ã¾ç¶­æŒ)
                const wVal = calculateWBGT(om.current.temperature_2m, om.current.relative_humidity_2m, om.current.shortwave_radiation, om.current.wind_speed_10m);
                const lv = getWBGTLevel(wVal);
                document.getElementById('env-wbgt').innerHTML = `<div class="flex flex-col"><span class="${lv.color} text-base font-bold">${lv.text}</span><span class="${lv.color} text-5xl font-black">${wVal}</span></div>`;

                const aqRes = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LOCATION_LAT}&longitude=${LOCATION_LON}&current=pm10,pm2_5&timezone=Asia%2FTokyo`);
                const aq = await aqRes.json();
                document.getElementById('env-pm25').innerHTML = `<span class="text-4xl font-black">${Math.round(aq.current.pm2_5)}</span><span class="text-sm font-bold ml-1">Î¼g</span>`;
                document.getElementById('env-sand').innerHTML = `<span class="text-4xl font-black">${Math.round(aq.current.pm10)}</span><span class="text-sm font-bold ml-1">Î¼g</span>`;

                const ovRes = await fetch(`https://www.jma.go.jp/bosai/forecast/data/overview_forecast/${JMA_OFFICE_CODE}.json`);
                const ov = await ovRes.json();
                document.getElementById('weather-overview').innerHTML = ov.text.replace(/\n/g, '<br>');

                // è­¦å ±
                const panel = document.getElementById('warning-panel');
                try {
                    const wngRes = await fetch(`https://www.jma.go.jp/bosai/warning/data/warning/${JMA_OFFICE_CODE}.json`);
                    const wng = await wngRes.json();
                    let miyakeW = Array.isArray(wng) ? wng[0]?.timeSeries?.[0]?.areas?.find(a => a.area.code === MIYAKE_AREA_CODE) : wng.timeSeries?.[0]?.areas?.find(a => a.area.code === MIYAKE_AREA_CODE);

                    if (!miyakeW || !miyakeW.warnings || miyakeW.warnings.filter(w => w.status === "ç™ºè¡¨" || w.status === "ç¶™ç¶š").length === 0) {
                        panel.className = "w-full h-full rounded-2xl bg-green-50 border-2 border-green-200 flex justify-center items-center";
                        panel.innerHTML = '<span class="text-2xl font-black text-green-600">ğŸŸ¢ ç•°å¸¸ãªã—</span>';
                    } else {
                        const activeW = miyakeW.warnings.filter(w => w.status === "ç™ºè¡¨" || w.status === "ç¶™ç¶š");
                        panel.className = "w-full h-full rounded-2xl bg-red-50 border-2 border-red-300 flex justify-center items-center flex-wrap gap-2 p-1 overflow-y-auto no-scrollbar";
                        panel.innerHTML = activeW.map(w => `<span class="text-sm font-bold bg-red-500 text-white px-2 py-0.5 rounded shadow-sm">âš ï¸${w.name}</span>`).join('');
                    }
                } catch (e) { panel.innerHTML = '<span class="text-gray-400 text-xs">è­¦å ±ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼</span>'; }

                // 1æ™‚é–“ã”ã¨ã®äºˆå ±
                const hrRes = await fetch(OPEN_METEO_URL);
                const hr = await hrRes.json();
                let hrHtml = '';
                const hNow = new Date().getHours();
                for (let i = 0; i < 24; i++) {
                    const idx = i + hNow;
                    if (!hr.hourly || !hr.hourly.time[idx]) break;
                    const hTime = new Date(hr.hourly.time[idx]).getHours();
                    const hT = Math.round(hr.hourly.temperature_2m[idx]);
                    const hW = calculateWBGT(hT, hr.hourly.relative_humidity_2m[idx], hr.hourly.shortwave_radiation[idx], hr.hourly.wind_speed_10m[idx]);
                    const hLv = getWBGTLevel(hW);
                    hrHtml += `
                        <div class="flex flex-col items-center justify-between min-w-[135px] bg-gray-50 rounded-2xl p-3 border-2 border-gray-100 shadow-sm h-full">
                            <span class="text-lg font-black text-gray-500">${hTime}æ™‚</span>
                            <span class="text-5xl my-1">${WMO_ICONS[hr.hourly.weathercode[idx]] || 'â˜ï¸'}</span>
                            <span class="text-3xl font-black text-gray-700">${hT}<span class="text-sm font-bold">â„ƒ</span></span>
                            <div class="w-full text-center p-1 rounded-lg border ${hLv.border} ${hLv.bg} flex flex-col items-center">
                                <span class="text-xs font-bold ${hLv.color}">${hLv.text}</span>
                                <span class="text-xl font-black ${hLv.color}">${hW}</span>
                            </div>
                        </div>
                    `;
                }
                document.getElementById('hourly-forecast-container').innerHTML = hrHtml;

            } catch (e) { console.error("UpdateData Error:", e); }
        }

        window.onload = () => {
            updateClock(); setInterval(updateClock, 1000);
            initRadar(); updateData(); setInterval(updateData, 600000);
        };
    </script>
</body>
</html>
